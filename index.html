<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Addition Practice Arena</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for bold aesthetics */
        :root {
            --color-primary: #4f46e5; /* Indigo */
            --color-success: #10b981; /* Green */
            --color-error: #ef4444; /* Red */
        }
        .text-huge {
            font-size: 5rem; /* 80px */
            line-height: 1;
        }
        .btn-submit {
            transition: all 0.1s ease-in-out;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-submit:active {
            transform: translateY(0);
        }
        .score-box {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 font-sans">
    <div id="game-container" class="w-full max-w-lg bg-white rounded-xl shadow-2xl p-6 md:p-10 border-t-8 border-indigo-600">

        <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-800 text-center mb-6 uppercase tracking-wider">
            Math Practice Master
        </h1>

        <!-- Score Display -->
        <div class="flex justify-around items-center mb-8 space-x-4">
            <div id="score-correct" class="score-box bg-green-100 p-4 rounded-lg text-center flex-1 transition duration-300">
                <p class="text-xl font-semibold text-green-700">Correct</p>
                <p class="text-3xl font-bold text-green-600 mt-1">0</p>
            </div>
            <div id="score-incorrect" class="score-box bg-red-100 p-4 rounded-lg text-center flex-1 transition duration-300">
                <p class="text-xl font-semibold text-red-700">Incorrect</p>
                <p class="text-3xl font-bold text-red-600 mt-1">0</p>
            </div>
        </div>

        <!-- Problem Area -->
        <div id="problem-area" class="text-center mb-8">
            <p id="question" class="text-huge font-black text-indigo-900 mb-6 select-none">
                <span id="num1">?</span> + <span id="num2">?</span> = <span class="text-indigo-400">?</span>
            </p>
        </div>

        <!-- Input and Submit -->
        <div class="flex flex-col space-y-4">
            <input type="number" id="answer-input" placeholder="Your Answer"
                   class="w-full p-4 text-3xl text-center border-4 border-indigo-300 rounded-xl focus:border-indigo-500 outline-none font-mono tracking-wider transition duration-200">
            <button id="submit-btn"
                    class="btn-submit w-full py-4 text-3xl font-bold bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150 shadow-lg shadow-indigo-500/50">
                SUBMIT
            </button>
        </div>

        <!-- Result Message -->
        <div id="result-message" class="mt-6 h-10 text-center">
            <!-- Message will appear here -->
        </div>
        
        <!-- Debug/User ID Display (Mandatory for multi-user/Firestore apps) -->
        <div class="mt-8 text-xs text-gray-500 text-center border-t pt-4">
            <p>Authentication Status: <span id="auth-status" class="font-semibold text-red-500">Initializing...</span></p>
            <p>User ID: <span id="user-id" class="break-all font-mono text-indigo-500"></span></p>
        </div>
    </div>

    <!-- JavaScript Game Logic and Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Globals (Mandatory check and usage)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-math-game-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = null;
        let scoreRef = null;

        // Game State
        let num1 = 0;
        let num2 = 0;
        let currentScore = { correct: 0, incorrect: 0 };
        let isProcessing = false;

        // DOM Elements
        const num1El = document.getElementById('num1');
        const num2El = document.getElementById('num2');
        const answerInput = document.getElementById('answer-input');
        const submitBtn = document.getElementById('submit-btn');
        const resultMessageEl = document.getElementById('result-message');
        const scoreCorrectEl = document.querySelector('#score-correct p:last-child');
        const scoreIncorrectEl = document.querySelector('#score-incorrect p:last-child');
        const authStatusEl = document.getElementById('auth-status');
        const userIdEl = document.getElementById('user-id');
        
        // --- Firebase Initialization and Auth ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Running without persistence.");
                authStatusEl.textContent = "Error (No Config)";
                authStatusEl.className = "font-semibold text-red-700";
                startGame();
                return;
            }
            
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Sign in using custom token or anonymously
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                authStatusEl.textContent = "Auth Failed";
                authStatusEl.className = "font-semibold text-red-700";
                // Even if auth fails, proceed to start the game without persistence.
                startGame();
            }

            // 2. Auth state listener for setting up Firestore
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUserId = user.uid;
                    authStatusEl.textContent = "Authenticated";
                    authStatusEl.className = "font-semibold text-green-600";
                    userIdEl.textContent = currentUserId;

                    // Define the score document path (Private Path)
                    const scorePath = `artifacts/${appId}/users/${currentUserId}/game_score/current_score`;
                    scoreRef = doc(db, scorePath);
                    
                    // Start listening to the score
                    subscribeToScore();
                } else {
                    currentUserId = null;
                    authStatusEl.textContent = "Not Signed In";
                    authStatusEl.className = "font-semibold text-red-500";
                    userIdEl.textContent = 'N/A';
                    // If the user logs out or fails to sign in, use default score
                    updateScoreUI(currentScore);
                }
                startGame();
            });
        }

        function subscribeToScore() {
            if (scoreRef) {
                onSnapshot(scoreRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentScore = docSnap.data();
                        console.log("Current score from Firestore:", currentScore);
                    } else {
                        // Document doesn't exist, create initial score
                        currentScore = { correct: 0, incorrect: 0 };
                        // Ensure initial document is created only once
                        setDoc(scoreRef, currentScore).catch(e => console.error("Error setting initial score:", e));
                        console.log("No score found, initialized to 0.");
                    }
                    updateScoreUI(currentScore);
                }, (error) => {
                    console.error("Firestore onSnapshot error:", error);
                    // Use default score in case of error
                    updateScoreUI(currentScore);
                });
            } else {
                console.warn("Score reference not set. Running without real-time updates.");
            }
        }

        async function updateScoreInFirestore(isCorrect) {
            if (!scoreRef || !currentUserId) {
                // If Firebase isn't ready or failed, just update local state
                if (isCorrect) currentScore.correct++;
                else currentScore.incorrect++;
                updateScoreUI(currentScore);
                console.warn("Firestore not ready. Score updated locally only.");
                return;
            }

            // Update local state first
            if (isCorrect) currentScore.correct++;
            else currentScore.incorrect++;

            try {
                // Since we are using onSnapshot, this update will automatically reflect in the UI
                await setDoc(scoreRef, currentScore, { merge: true });
                console.log("Score updated in Firestore.");
            } catch (error) {
                console.error("Error updating score in Firestore:", error);
            }
        }

        function updateScoreUI(score) {
            scoreCorrectEl.textContent = score.correct;
            scoreIncorrectEl.textContent = score.incorrect;
            
            // Apply pulse effect to the score boxes
            const correctBox = scoreCorrectEl.closest('.score-box');
            const incorrectBox = scoreIncorrectEl.closest('.score-box');

            correctBox.classList.remove('animate-pulse');
            incorrectBox.classList.remove('animate-pulse');

            // Simple animation for updates
            setTimeout(() => {
                correctBox.classList.add('animate-pulse');
                incorrectBox.classList.add('animate-pulse');
            }, 50);

            setTimeout(() => {
                correctBox.classList.remove('animate-pulse');
                incorrectBox.classList.remove('animate-pulse');
            }, 500);
        }
        
        // --- Game Logic ---

        function generateProblem() {
            // Generate numbers between 1 and 99 for challenging addition
            num1 = Math.floor(Math.random() * 99) + 1;
            num2 = Math.floor(Math.random() * 99) + 1;
            
            num1El.textContent = num1;
            num2El.textContent = num2;
            answerInput.value = ''; // Clear previous input
            answerInput.focus();
            resultMessageEl.innerHTML = ''; // Clear result message
            submitBtn.disabled = false;
        }

        function checkAnswer() {
            if (isProcessing) return;
            isProcessing = true;

            const userAnswer = parseInt(answerInput.value, 10);
            const correctAnswer = num1 + num2;

            if (isNaN(userAnswer)) {
                showMessage("Please enter a number!", 'text-yellow-600');
                isProcessing = false;
                return;
            }

            submitBtn.disabled = true;

            if (userAnswer === correctAnswer) {
                showMessage("✅ Correct! That's " + correctAnswer, 'text-green-600 font-bold');
                updateScoreInFirestore(true);
            } else {
                showMessage(`❌ Incorrect! The answer was ${correctAnswer}`, 'text-red-600 font-bold');
                updateScoreInFirestore(false);
            }

            // Wait a moment before loading the next question
            setTimeout(() => {
                isProcessing = false;
                generateProblem();
            }, 1500);
        }

        function showMessage(text, className) {
            resultMessageEl.innerHTML = `<p class="text-2xl ${className}">${text}</p>`;
        }

        function handleInput(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }

        function startGame() {
            // Attach event listeners only once
            submitBtn.addEventListener('click', checkAnswer);
            answerInput.addEventListener('keydown', handleInput);
            
            // Generate the first problem
            if (!currentUserId) {
                generateProblem(); // Start game immediately if not using persistence
            }
        }

        // --- Main Execution ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>